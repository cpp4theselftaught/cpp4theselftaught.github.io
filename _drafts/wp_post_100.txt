ID: 112
post_author: 1
post_date: "2014-03-31 11:06:34"
post_date_gmt: "2014-03-31 15:06:34"
post_content: "n<div class="topsy_widget_data topsy_theme_blue" style="float: right;margin-left: 0.75em; background: url(data:,%7B%20%22url%22%3A%20%22http%253A%252F%252Frlc.vlinder.ca%252Fblog%252F2011%252F12%252Fsetting-up-a-new-skeleton-re-factoring%252F%22%2C%20%22shorturl%22%3A%20%22http%3A%2F%2Fbit.ly%2Ftpt6Md%22%2C%20%22style%22%3A%20%22big%22%2C%20%22title%22%3A%20%22Setting%20up%20a%20new%20skeleton%3A%20re-factoring%22%20%7D);"></div>n<p> <audio id="wp_mep_1" src="http://vlinder.ca/podcasts/35-refactored.mp3" controls="controls" preload="none" >n n n n n n n n <object width="400" height="30" type="application/x-shockwave-flash" data="http://rlc.vlinder.ca/wp-content/plugins/media-element-html5-video-and-audio-player/mediaelement/flashmediaelement.swf">n <param name="movie" value="http://rlc.vlinder.ca/wp-content/plugins/media-element-html5-video-and-audio-player/mediaelement/flashmediaelement.swf" />n <param name="flashvars" value="controls=true&amp;file=http://vlinder.ca/podcasts/35-refactored.mp3" /> n </object> n </audio>n<script type="text/javascript">njQuery(document).ready(function($) {n $('#wp_mep_1').mediaelementplayer({n m:1n n ,features: ['playpause','current','progress','duration','volume','tracks','fullscreen']n ,audioWidth:400,audioHeight:30n });n});n</script>nBefore we go much further with our SOCKS server, we should do a bit of cleaning up in the project: we&#8217;ll move the <code>Server</code> and <code>Observer</code> classes to their own library, so we can more easily re-use them, and we&#8217;ll copy the <code>Application</code> class over to our new project &#8212; the one that will become our next step towards a fully functional SOCKS server: <em>Episode35</em>.<br />n<span id="more-1722"></span><br />nMost of the dreary details are clearly visible in the diff of the <a href="https://gitorious.org/chausette/chausette/commit/209bb84/diffs" title="the commit diffs" >main commit</a> but a few interesting details show up when we compare the two <code>Application</code> classes:<br />n<div class="aside-toggler closed"><span class="open-aside code">To see the <em>code</em> click here.</span><span class="close-aside code">To hide the <em>code</em> click here.</span>n </div><div class="bnsia aside code closed"></p>nn<div class="wp_syntax"><table><tr><td class="code"><pre class="diff" style="font-family:monospace;"><span style="color: #888822;">--- bin/Episode28/Application.cpp 2011-09-26 19:58:52.938883900 -0400</span>n<span style="color: #888822;">+++ bin/Episode35/Application.cpp 2011-10-19 21:28:29.080693800 -0400</span>n<span style="color: #440088;">@@ -3,17 +3,51 @@</span>n #include &lt;boost/lexical_cast.hpp&gt;n #include &lt;iostream&gt;n #include &lt;vector&gt;n<span style="color: #00b000;">+#include &lt;ws2ipdef.h&gt;</span>n<span style="color: #00b000;">+#include &lt;WinSock2.h&gt;</span>n #include &quot;server/Server.h&quot;n #include &quot;config.h&quot;n<span style="color: #00b000;">+#include &quot;rfc1928/types.h&quot;</span>n&nbsp;n using namespace std;n using namespace boost;n&nbsp;n<span style="color: #00b000;">+struct Application::FDGuard</span>n<span style="color: #00b000;">+<span style="">&#123;</span></span>n<span style="color: #00b000;">+ FDGuard<span style="">&#40;</span>int fd<span style="">&#41;</span></span>n<span style="color: #00b000;">+ : fd_<span style="">&#40;</span>fd<span style="">&#41;</span></span>n<span style="color: #00b000;">+ , dismissed_<span style="">&#40;</span>false<span style="">&#41;</span></span>n<span style="color: #00b000;">+ <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old no-op */ <span style="">&#125;</span></span>n<span style="color: #00b000;">+</span>n<span style="color: #00b000;">+ ~FDGuard<span style="">&#40;</span><span style="">&#41;</span></span>n<span style="color: #00b000;">+ <span style="">&#123;</span></span>n<span style="color: #00b000;">+ if <span style="">&#40;</span>!dismissed_<span style="">&#41;</span></span>n<span style="color: #00b000;">+ <span style="">&#123;</span></span>n<span style="color: #00b000;">+ closesocket<span style="">&#40;</span>fd_<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ else</span>n<span style="color: #00b000;">+ <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old dismissed */ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ <span style="">&#125;</span></span>n<span style="color: #00b000;">+</span>n<span style="color: #00b000;">+ void dismiss<span style="">&#40;</span><span style="">&#41;</span></span>n<span style="color: #00b000;">+ <span style="">&#123;</span></span>n<span style="color: #00b000;">+ dismissed_ = true;</span>n<span style="color: #00b000;">+ <span style="">&#125;</span></span>n<span style="color: #00b000;">+</span>n<span style="color: #00b000;">+private :</span>n<span style="color: #00b000;">+ FDGuard<span style="">&#40;</span>const FDGuard&amp;<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ FDGuard&amp; operator=<span style="">&#40;</span>const FDGuard&amp;<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+</span>n<span style="color: #00b000;">+ int fd_;</span>n<span style="color: #00b000;">+ bool dismissed_;</span>n<span style="color: #00b000;">+<span style="">&#125;</span>;</span>n<span style="color: #00b000;">+</span>n Application::Application<span style="">&#40;</span><span style="">&#41;</span>n : server_<span style="">&#40;</span><span style="">0</span><span style="">&#41;</span>n<span style="color: #991111;">-, data_to_send_attribute_id_<span style="">&#40;</span>Socket::alloc<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span></span>n<span style="color: #991111;">-, target_address_attribute_id_<span style="">&#40;</span>Socket::alloc<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span></span>n<span style="color: #991111;">-, un_paired_socket_<span style="">&#40;</span>0<span style="">&#41;</span></span>n<span style="color: #00b000;">+, socket_state_attribute_id_<span style="">&#40;</span>Socket::alloc<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span></span>n<span style="color: #00b000;">+, receive_buffer_attribute_id_<span style="">&#40;</span>Socket::alloc<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span></span>n<span style="color: #00b000;">+, send_buffer_attribute_id_<span style="">&#40;</span>Socket::alloc<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span></span>n<span style="color: #00b000;">+, socks_reply_attribute_id_<span style="">&#40;</span>Socket::alloc<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span></span>n <span style="">&#123;</span>n WSADATA wsadata;n WSAStartup<span style="">&#40;</span>MAKEWORD<span style="">&#40;</span><span style="">2</span>, <span style="">2</span><span style="">&#41;</span>, &amp;wsadata<span style="">&#41;</span>;n<span style="color: #440088;">@@ -29,8 +63,8 @@ void Application::run<span style="">&#40;</span>const Application:</span>n // for now, expect our own path in arguments<span style="">&#91;</span><span style="">0</span><span style="">&#93;</span>, the IP address to n // listen on in arguments<span style="">&#91;</span><span style="">1</span><span style="">&#93;</span> and the port in arguments<span style="">&#91;</span><span style="">2</span><span style="">&#93;</span>n assert<span style="">&#40;</span>arguments.size<span style="">&#40;</span><span style="">&#41;</span> &gt;= <span style="">1</span><span style="">&#41;</span>;n<span style="color: #991111;">- string ip<span style="">&#40;</span>arguments.size<span style="">&#40;</span><span style="">&#41;</span> &gt; <span style="">1</span> ? arguments<span style="">&#91;</span><span style="">1</span><span style="">&#93;</span> : CHAUSETTE_EPISODE28_DEFAULT_IP<span style="">&#41;</span>;</span>n<span style="color: #991111;">- unsigned short port<span style="">&#40;</span>arguments.size<span style="">&#40;</span><span style="">&#41;</span> &gt; <span style="">2</span> ? boost::lexical_cast&lt; unsigned short &gt;<span style="">&#40;</span>arguments<span style="">&#91;</span><span style="">2</span><span style="">&#93;</span><span style="">&#41;</span> : CHAUSETTE_EPISODE28_DEFAULT_PORT<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ string ip<span style="">&#40;</span>arguments.size<span style="">&#40;</span><span style="">&#41;</span> &gt; <span style="">1</span> ? arguments<span style="">&#91;</span><span style="">1</span><span style="">&#93;</span> : CHAUSETTE_EPISODE35_DEFAULT_IP<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ unsigned short port<span style="">&#40;</span>arguments.size<span style="">&#40;</span><span style="">&#41;</span> &gt; <span style="">2</span> ? boost::lexical_cast&lt; unsigned short &gt;<span style="">&#40;</span>arguments<span style="">&#91;</span><span style="">2</span><span style="">&#93;</span><span style="">&#41;</span> : CHAUSETTE_EPISODE35_DEFAULT_PORT<span style="">&#41;</span>;</span>n sockaddr_storage address;n memset<span style="">&#40;</span>&amp;address, <span style="">0</span>, sizeof<span style="">&#40;</span>address<span style="">&#41;</span><span style="">&#41;</span>;n sockaddr_in &amp;in_address = reinterpret_cast&lt; sockaddr_in&amp; &gt;<span style="">&#40;</span>address<span style="">&#41;</span>;n<span style="color: #440088;">@@ -62,128 +96,405 @@ void Application::run<span style="">&#40;</span>const Application:</span>n /*virtual */void Application::onNewConnection<span style="">&#40;</span>Socket &amp;socket<span style="">&#41;</span>n <span style="">&#123;</span>n Socket &amp;new_socket<span style="">&#40;</span>server_-&gt;accept<span style="">&#40;</span>socket<span style="">&#41;</span><span style="">&#41;</span>;n<span style="color: #991111;">- remote_address_to_socket_.insert<span style="">&#40;</span>RemoteAddressToSocket::value_type<span style="">&#40;</span>new_socket.remote_address_, &amp;new_socket<span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #991111;">- pairSocket<span style="">&#40;</span>new_socket<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ new_socket.get<span style="">&#40;</span>socket_state_attribute_id_<span style="">&#41;</span> = expect_authentication_method_request__;</span>n <span style="">&#125;</span>n&nbsp;n /*virtual */void Application::onDataReady<span style="">&#40;</span>Socket &amp;socket<span style="">&#41;</span>n <span style="">&#123;</span>n<span style="color: #991111;">- vector&lt; char &gt; temp; // in case the socket is un-paired</span>n<span style="color: #991111;">- bool needed_to_initialize<span style="">&#40;</span>false<span style="">&#41;</span>;</span>n<span style="color: #991111;">- vector&lt; char &gt;::size_type offset<span style="">&#40;</span><span style="">0</span><span style="">&#41;</span>;</span>n<span style="color: #991111;">- Socket *partner<span style="">&#40;</span><span style="">&#40;</span>&amp;socket == un_paired_socket_<span style="">&#41;</span> ? <span style="">0</span> : remote_address_to_socket_<span style="">&#91;</span>any_cast&lt; sockaddr_storage &gt;<span style="">&#40;</span>socket.get<span style="">&#40;</span>target_address_attribute_id_<span style="">&#41;</span><span style="">&#41;</span><span style="">&#93;</span><span style="">&#41;</span>;</span>n<span style="color: #991111;">- if <span style="">&#40;</span>partner &amp;&amp;</span>n<span style="color: #991111;">- partner-&gt;get<span style="">&#40;</span>data_to_send_attribute_id_<span style="">&#41;</span>.empty<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span></span>n<span style="color: #00b000;">+ if <span style="">&#40;</span>socket.get<span style="">&#40;</span>receive_buffer_attribute_id_<span style="">&#41;</span>.empty<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span></span>n <span style="">&#123;</span>n<span style="color: #991111;">- partner-&gt;get<span style="">&#40;</span>data_to_send_attribute_id_<span style="">&#41;</span> = vector&lt; char &gt;<span style="">&#40;</span><span style="">1024</span><span style="">&#41;</span>;</span>n<span style="color: #991111;">- needed_to_initialize = true;</span>n<span style="color: #00b000;">+ socket.get<span style="">&#40;</span>receive_buffer_attribute_id_<span style="">&#41;</span> = Buffer<span style="">&#40;</span>default_buffer_size__<span style="">&#41;</span>;</span>n <span style="">&#125;</span>n<span style="color: #991111;">- else if <span style="">&#40;</span>partner<span style="">&#41;</span></span>n<span style="color: #991111;">- <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old already have a buffer */ <span style="">&#125;</span></span>n elsen<span style="color: #991111;">- <span style="">&#123;</span></span>n<span style="color: #991111;">- temp.resize<span style="">&#40;</span><span style="">1024</span><span style="">&#41;</span>;</span>n<span style="color: #991111;">- needed_to_initialize = true;</span>n<span style="color: #991111;">- <span style="">&#125;</span></span>n<span style="color: #991111;">- vector&lt; char &gt; &amp;buffer = partner ? any_cast&lt; vector&lt; char &gt;&amp; &gt;<span style="">&#40;</span>partner-&gt;get<span style="">&#40;</span>data_to_send_attribute_id_<span style="">&#41;</span><span style="">&#41;</span> : temp;</span>n<span style="color: #991111;">- if <span style="">&#40;</span>!needed_to_initialize &amp;&amp; buffer.empty<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span></span>n<span style="color: #00b000;">+ <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old already have a receive buffer */ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ Buffer &amp;buffer<span style="">&#40;</span>any_cast&lt; Buffer&amp; &gt;<span style="">&#40;</span>socket.get<span style="">&#40;</span>receive_buffer_attribute_id_<span style="">&#41;</span><span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ Buffer::size_type offset<span style="">&#40;</span><span style="">0</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ if <span style="">&#40;</span>buffer.empty<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span></span>n <span style="">&#123;</span>n buffer.resize<span style="">&#40;</span>buffer.capacity<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span>;n <span style="">&#125;</span>n<span style="color: #991111;">- else if <span style="">&#40;</span>!needed_to_initialize<span style="">&#41;</span></span>n<span style="color: #00b000;">+ else</span>n <span style="">&#123;</span>n offset = buffer.size<span style="">&#40;</span><span style="">&#41;</span>;n<span style="color: #991111;">- if <span style="">&#40;</span>buffer.capacity<span style="">&#40;</span><span style="">&#41;</span> &lt;= offset + 1024<span style="">&#41;</span></span>n<span style="color: #00b000;">+ if <span style="">&#40;</span>buffer.capacity<span style="">&#40;</span><span style="">&#41;</span> - offset &lt; minimal_available_buffer_size__<span style="">&#41;</span></span>n <span style="">&#123;</span>n<span style="color: #991111;">- buffer.resize<span style="">&#40;</span>offset + <span style="">1024</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ buffer.resize<span style="">&#40;</span>offset + minimal_available_buffer_size__<span style="">&#41;</span>;</span>n <span style="">&#125;</span>n elsen <span style="">&#123;</span>n buffer.resize<span style="">&#40;</span>buffer.capacity<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span>;n <span style="">&#125;</span>n <span style="">&#125;</span>n<span style="color: #00b000;">+ Buffer::size_type avail<span style="">&#40;</span>buffer.size<span style="">&#40;</span><span style="">&#41;</span> - offset<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ Buffer::pointer recv_ptr<span style="">&#40;</span>&amp;<span style="">&#40;</span>buffer<span style="">&#91;</span>offset<span style="">&#93;</span><span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ server_-&gt;read<span style="">&#40;</span>socket, recv_ptr, &amp;avail<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ buffer.resize<span style="">&#40;</span>offset + avail<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ // here, according to the state of the socket, dispatch the data</span>n<span style="color: #00b000;">+ if <span style="">&#40;</span>socket.get<span style="">&#40;</span>socket_state_attribute_id_<span style="">&#41;</span>.empty<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span></span>n<span style="color: #00b000;">+ <span style="">&#123;</span></span>n<span style="color: #00b000;">+ socket.get<span style="">&#40;</span>socket_state_attribute_id_<span style="">&#41;</span> = expect_authentication_method_request__;</span>n<span style="color: #00b000;">+ <span style="">&#125;</span></span>n elsen<span style="color: #991111;">- <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old needed to initialize - so no need to account for data already in the buffer */ <span style="">&#125;</span></span>n<span style="color: #991111;">- unsigned int data_read<span style="">&#40;</span>buffer.size<span style="">&#40;</span><span style="">&#41;</span> - offset<span style="">&#41;</span>;</span>n<span style="color: #991111;">- char *read_ptr<span style="">&#40;</span>&amp;buffer<span style="">&#91;</span><span style="">0</span><span style="">&#93;</span><span style="">&#41;</span>;</span>n<span style="color: #991111;">- read_ptr += offset;</span>n<span style="color: #991111;">- try</span>n<span style="color: #00b000;">+ <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old the socket already has a state */ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ switch <span style="">&#40;</span>any_cast&lt; SocketState &gt;<span style="">&#40;</span>socket.get<span style="">&#40;</span>socket_state_attribute_id_<span style="">&#41;</span>.empty<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span><span style="">&#41;</span></span>n <span style="">&#123;</span>n<span style="color: #991111;">- server_-&gt;read<span style="">&#40;</span>socket, read_ptr, &amp;data_read<span style="">&#41;</span>;</span>n<span style="color: #991111;">- buffer.resize<span style="">&#40;</span>offset + data_read<span style="">&#41;</span>;</span>n<span style="color: #991111;">- unsigned int data_written<span style="">&#40;</span>buffer.size<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #991111;">- if <span style="">&#40;</span>partner<span style="">&#41;</span></span>n<span style="color: #00b000;">+ case expect_authentication_method_request__ :</span>n<span style="color: #00b000;">+ onAuthenticationMethodRequest<span style="">&#40;</span>socket<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ break;</span>n<span style="color: #00b000;">+ case expect_socks_request__ :</span>n<span style="color: #00b000;">+ onSocksRequest<span style="">&#40;</span>socket<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ break;</span>n<span style="color: #00b000;">+ <span style="">&#125;</span></span>n<span style="color: #00b000;">+<span style="">&#125;</span></span>n<span style="color: #00b000;">+</span>n<span style="color: #00b000;">+/*virtual */void Application::onWriteReady<span style="">&#40;</span>Socket &amp;socket<span style="">&#41;</span></span>n <span style="">&#123;</span>n<span style="color: #991111;">- server_-&gt;write<span style="">&#40;</span>*partner, &amp;buffer<span style="">&#91;</span><span style="">0</span><span style="">&#93;</span>, &amp;data_written<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ if <span style="">&#40;</span>!socket.get<span style="">&#40;</span>send_buffer_attribute_id_<span style="">&#41;</span>.empty<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span></span>n<span style="color: #00b000;">+ <span style="">&#123;</span></span>n<span style="color: #00b000;">+ Buffer &amp;buffer<span style="">&#40;</span>any_cast&lt; Buffer&amp; &gt;<span style="">&#40;</span>socket.get<span style="">&#40;</span>send_buffer_attribute_id_<span style="">&#41;</span><span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ Buffer::size_type offset<span style="">&#40;</span><span style="">0</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ if <span style="">&#40;</span>!buffer.empty<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span></span>n<span style="color: #00b000;">+ <span style="">&#123;</span></span>n<span style="color: #00b000;">+ Buffer::size_type avail<span style="">&#40;</span>buffer.size<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ Buffer::pointer send_ptr<span style="">&#40;</span>&amp;<span style="">&#40;</span>buffer<span style="">&#91;</span><span style="">0</span><span style="">&#93;</span><span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ server_-&gt;write<span style="">&#40;</span>socket, send_ptr, &amp;avail<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ buffer.erase<span style="">&#40;</span>buffer.begin<span style="">&#40;</span><span style="">&#41;</span>, buffer.begin<span style="">&#40;</span><span style="">&#41;</span> + avail<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ else</span>n<span style="color: #00b000;">+ <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old nothing to send */ <span style="">&#125;</span></span>n <span style="">&#125;</span>n elsen<span style="color: #991111;">- <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old no partner to send data to */ <span style="">&#125;</span></span>n<span style="color: #991111;">- buffer.erase<span style="">&#40;</span>buffer.begin<span style="">&#40;</span><span style="">&#41;</span>, buffer.begin<span style="">&#40;</span><span style="">&#41;</span> + data_written<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old nothing to send */ <span style="">&#125;</span></span>n <span style="">&#125;</span>n<span style="color: #991111;">- catch <span style="">&#40;</span>const Server::NetworkError&amp;<span style="">&#41;</span></span>n<span style="color: #00b000;">+</span>n<span style="color: #00b000;">+/*virtual */void Application::onExceptionalDataReady<span style="">&#40;</span>Socket &amp;socket<span style="">&#41;</span></span>n <span style="">&#123;</span>n<span style="color: #991111;">- // ignore this for now: the socket will have been dealt with but this is no reason for us to crash.</span>n <span style="">&#125;</span>n<span style="color: #00b000;">+</span>n<span style="color: #00b000;">+/*virtual */void Application::onCloseSocket<span style="">&#40;</span>Socket &amp;socket<span style="">&#41;</span></span>n<span style="color: #00b000;">+<span style="">&#123;</span></span>n <span style="">&#125;</span>n&nbsp;n<span style="color: #991111;">-/*virtual */void Application::onWriteReady<span style="">&#40;</span>Socket &amp;socket<span style="">&#41;</span></span>n<span style="color: #00b000;">+void Application::onAuthenticationMethodRequest<span style="">&#40;</span>Socket &amp;socket<span style="">&#41;</span> const</span>n <span style="">&#123;</span>n<span style="color: #991111;">- if <span style="">&#40;</span>socket.get<span style="">&#40;</span>data_to_send_attribute_id_<span style="">&#41;</span>.empty<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span></span>n<span style="color: #991111;">- <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old no-op */ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ using Vlinder::Chausette::RFC1928::VersionIdentifierMethodSelectionMessage;</span>n<span style="color: #00b000;">+ using Vlinder::Chausette::RFC1928::MethodMessage;</span>n<span style="color: #00b000;">+ Buffer &amp;buffer<span style="">&#40;</span>any_cast&lt; Buffer&amp; &gt;<span style="">&#40;</span>socket.get<span style="">&#40;</span>receive_buffer_attribute_id_<span style="">&#41;</span><span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ if <span style="">&#40;</span>buffer.size<span style="">&#40;</span><span style="">&#41;</span> &lt; offsetof<span style="">&#40;</span>VersionIdentifierMethodSelectionMessage, methods_<span style="">&#41;</span> + 1<span style="">&#41;</span></span>n<span style="color: #00b000;">+ <span style="">&#123;</span></span>n<span style="color: #00b000;">+ throw InsufficientData<span style="">&#40;</span>&quot;Not enough data for a version identifier/method selection message&quot;<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ <span style="">&#125;</span></span>n elsen<span style="color: #00b000;">+ <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old all is well so far */ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ VersionIdentifierMethodSelectionMessage *message<span style="">&#40;</span>reinterpret_cast&lt; VersionIdentifierMethodSelectionMessage* &gt;<span style="">&#40;</span>&amp;buffer<span style="">&#91;</span><span style="">0</span><span style="">&#93;</span><span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ if <span style="">&#40;</span>message-&gt;ver_ != CHAUSETTE_EPISODE35_SOCKS_VERSION<span style="">&#41;</span></span>n <span style="">&#123;</span>n<span style="color: #991111;">- vector&lt; char &gt; &amp;buffer = any_cast&lt; vector&lt; char &gt;&amp; &gt;<span style="">&#40;</span>socket.get<span style="">&#40;</span>data_to_send_attribute_id_<span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #991111;">- if <span style="">&#40;</span>buffer.empty<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span></span>n<span style="color: #991111;">- <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old no-op */ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ throw WrongSocksVersion<span style="">&#40;</span>&quot;Wrong socks version&quot;, CHAUSETTE_EPISODE35_SOCKS_VERSION, message-&gt;ver_<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ else</span>n<span style="color: #00b000;">+ <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old the version is OK */ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ if <span style="">&#40;</span>buffer.size<span style="">&#40;</span><span style="">&#41;</span> &lt; offsetof<span style="">&#40;</span>VersionIdentifierMethodSelectionMessage, methods_<span style="">&#41;</span> + message-&gt;nmethods_<span style="">&#41;</span></span>n<span style="color: #00b000;">+ <span style="">&#123;</span></span>n<span style="color: #00b000;">+ throw InsufficientData<span style="">&#40;</span>&quot;Not enough data for a version identifier/method selection message&quot;<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ <span style="">&#125;</span></span>n elsen<span style="color: #00b000;">+ <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old all is well so far */ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old As we haven't implemented any authentication methods yet, we only </span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml support &quot;no authentication&quot; - method 0. If it is not present among </span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml the methods, throw an exception. */</span>n<span style="color: #00b000;">+ bool authentication_ok<span style="">&#40;</span>false<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ for <span style="">&#40;</span>unsigned char *method = message-&gt;methods_; !authentication_ok &amp;&amp; <span style="">&#40;</span><span style="">&#40;</span>method - message-&gt;methods_<span style="">&#41;</span> &lt; message-&gt;nmethods_<span style="">&#41;</span>; ++method<span style="">&#41;</span></span>n <span style="">&#123;</span>n<span style="color: #991111;">- unsigned int data_written<span style="">&#40;</span>buffer.size<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #991111;">- server_-&gt;write<span style="">&#40;</span>socket, &amp;buffer<span style="">&#91;</span><span style="">0</span><span style="">&#93;</span>, &amp;data_written<span style="">&#41;</span>;</span>n<span style="color: #991111;">- buffer.erase<span style="">&#40;</span>buffer.begin<span style="">&#40;</span><span style="">&#41;</span>, buffer.begin<span style="">&#40;</span><span style="">&#41;</span> + data_written<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ authentication_ok = <span style="">&#40;</span>*method == <span style="">0</span><span style="">&#41;</span>;</span>n <span style="">&#125;</span>n<span style="color: #00b000;">+ if <span style="">&#40;</span>!authentication_ok<span style="">&#41;</span></span>n<span style="color: #00b000;">+ <span style="">&#123;</span></span>n<span style="color: #00b000;">+ throw NoSupportedAuthenticationMethod<span style="">&#40;</span>&quot;No supported authentication method&quot;<span style="">&#41;</span>;</span>n <span style="">&#125;</span>n<span style="color: #00b000;">+ else</span>n<span style="color: #00b000;">+ <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old all is well */ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ MethodMessage methodMessage<span style="">&#40;</span>CHAUSETTE_EPISODE35_SOCKS_VERSION, <span style="">0</span>/* no authentication - put a constant here later */<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ unsigned char *ptr<span style="">&#40;</span>reinterpret_cast&lt; unsigned char* &gt;<span style="">&#40;</span>&amp;methodMessage<span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ queueDataToSend<span style="">&#40;</span>socket, ptr, ptr + sizeof<span style="">&#40;</span>methodMessage<span style="">&#41;</span><span style="">&#41;</span>;</span>n <span style="">&#125;</span>n&nbsp;n<span style="color: #991111;">-/*virtual */void Application::onExceptionalDataReady<span style="">&#40;</span>Socket &amp;socket<span style="">&#41;</span></span>n<span style="color: #00b000;">+void Application::onSocksRequest<span style="">&#40;</span>Socket &amp;socket<span style="">&#41;</span></span>n <span style="">&#123;</span>n<span style="color: #00b000;">+ using Vlinder::Chausette::RFC1928::SocksRequest;</span>n<span style="color: #00b000;">+ Buffer &amp;buffer<span style="">&#40;</span>any_cast&lt; Buffer&amp; &gt;<span style="">&#40;</span>socket.get<span style="">&#40;</span>receive_buffer_attribute_id_<span style="">&#41;</span><span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ if <span style="">&#40;</span>buffer.size<span style="">&#40;</span><span style="">&#41;</span> &lt; offsetof<span style="">&#40;</span>SocksRequest, dst_addr_<span style="">&#41;</span> + 1<span style="">&#41;</span></span>n<span style="color: #00b000;">+ <span style="">&#123;</span></span>n<span style="color: #00b000;">+ throw InsufficientData<span style="">&#40;</span>&quot;Not enough data for a SOCKS request&quot;<span style="">&#41;</span>;</span>n <span style="">&#125;</span>n<span style="color: #991111;">-</span>n<span style="color: #991111;">-/*virtual */void Application::onCloseSocket<span style="">&#40;</span>Socket &amp;socket<span style="">&#41;</span></span>n<span style="color: #00b000;">+ else</span>n<span style="color: #00b000;">+ <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old all is well so far */ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ SocksRequest *message<span style="">&#40;</span>reinterpret_cast&lt; SocksRequest* &gt;<span style="">&#40;</span>&amp;buffer<span style="">&#91;</span><span style="">0</span><span style="">&#93;</span><span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ if <span style="">&#40;</span>message-&gt;ver_ != CHAUSETTE_EPISODE35_SOCKS_VERSION<span style="">&#41;</span></span>n <span style="">&#123;</span>n<span style="color: #991111;">- RemoteAddressToSocket::iterator where<span style="">&#40;</span>remote_address_to_socket_.find<span style="">&#40;</span>socket.remote_address_<span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #991111;">- assert<span style="">&#40;</span>where != remote_address_to_socket_.end<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #991111;">- assert<span style="">&#40;</span>where-&gt;second == &amp;socket<span style="">&#41;</span>;</span>n<span style="color: #991111;">- remote_address_to_socket_.erase<span style="">&#40;</span>where<span style="">&#41;</span>;</span>n<span style="color: #991111;">- unpairSocket<span style="">&#40;</span>socket<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ throw WrongSocksVersion<span style="">&#40;</span>&quot;Wrong SOCKS version&quot;, CHAUSETTE_EPISODE35_SOCKS_VERSION, message-&gt;ver_<span style="">&#41;</span>;</span>n <span style="">&#125;</span>n<span style="color: #991111;">-</span>n<span style="color: #991111;">-void Application::pairSocket<span style="">&#40;</span>Socket &amp;socket<span style="">&#41;</span></span>n<span style="color: #00b000;">+ else</span>n<span style="color: #00b000;">+ <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old the version is OK */ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old Inside the message, the port field is the only one that isn't </span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml necessarily in the same position as in the struct. The other</span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml fields are where they should be - and we can get to the port </span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml field by pasing the address type field. */</span>n<span style="color: #00b000;">+ sockaddr_storage address;</span>n<span style="color: #00b000;">+ memset<span style="">&#40;</span>&amp;address, <span style="">0</span>, sizeof<span style="">&#40;</span>address<span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ switch <span style="">&#40;</span>message-&gt;atyp_<span style="">&#41;</span></span>n <span style="">&#123;</span>n<span style="color: #991111;">- if <span style="">&#40;</span>un_paired_socket_<span style="">&#41;</span></span>n<span style="color: #00b000;">+ case 1 :</span>n <span style="">&#123;</span>n<span style="color: #991111;">- un_paired_socket_-&gt;get<span style="">&#40;</span>target_address_attribute_id_<span style="">&#41;</span> = socket.remote_address_;</span>n<span style="color: #991111;">- socket.get<span style="">&#40;</span>target_address_attribute_id_<span style="">&#41;</span> = un_paired_socket_-&gt;remote_address_;</span>n<span style="color: #991111;">- un_paired_socket_ = <span style="">0</span>;</span>n<span style="color: #00b000;">+ // IP V4 address: X'01'</span>n<span style="color: #00b000;">+ if <span style="">&#40;</span>buffer.size<span style="">&#40;</span><span style="">&#41;</span> &lt; offsetof<span style="">&#40;</span>SocksRequest, dst_addr_<span style="">&#41;</span> + 6 /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old four for the address, two for the port */<span style="">&#41;</span></span>n<span style="color: #00b000;">+ <span style="">&#123;</span></span>n<span style="color: #00b000;">+ throw InsufficientData<span style="">&#40;</span>&quot;Not enough data for a SOCKS request&quot;<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ else</span>n<span style="color: #00b000;">+ <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old all is well so far */ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ address.ss_family = AF_INET;</span>n<span style="color: #00b000;">+ sockaddr_in *a4<span style="">&#40;</span>reinterpret_cast&lt; sockaddr_in* &gt;<span style="">&#40;</span>&amp;address<span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ memcpy<span style="">&#40;</span>&amp;a4-&gt;sin_addr, message-&gt;dst_addr_, <span style="">4</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ memcpy<span style="">&#40;</span>&amp;a4-&gt;sin_port, message-&gt;dst_addr_ + <span style="">4</span>, <span style="">2</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ break;</span>n<span style="color: #00b000;">+ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ case 3 :</span>n<span style="color: #00b000;">+ <span style="">&#123;</span></span>n<span style="color: #00b000;">+ // DOMAINNAME: X'03'</span>n<span style="color: #00b000;">+ unsigned char hostname_length<span style="">&#40;</span>message-&gt;dst_addr_<span style="">&#91;</span><span style="">0</span><span style="">&#93;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ if <span style="">&#40;</span>buffer.size<span style="">&#40;</span><span style="">&#41;</span> &lt; offsetof<span style="">&#40;</span>SocksRequest, dst_addr_<span style="">&#41;</span> + hostname_length + 2 /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old hostname_length for the address, two for the port */<span style="">&#41;</span></span>n<span style="color: #00b000;">+ <span style="">&#123;</span></span>n<span style="color: #00b000;">+ throw InsufficientData<span style="">&#40;</span>&quot;Not enough data for a SOCKS request&quot;<span style="">&#41;</span>;</span>n <span style="">&#125;</span>n elsen<span style="color: #00b000;">+ <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old all is well so far */ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ char *hostname_begin<span style="">&#40;</span>reinterpret_cast&lt; char* &gt;<span style="">&#40;</span>message-&gt;dst_addr_ + <span style="">1</span><span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ char *hostname_end = hostname_begin + hostname_length;</span>n<span style="color: #00b000;">+ unsigned short port<span style="">&#40;</span>*reinterpret_cast&lt; unsigned short* &gt;<span style="">&#40;</span>hostname_end<span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ *hostname_end = <span style="">0</span>; // cap it off</span>n<span style="color: #00b000;">+ hostent *host_entry<span style="">&#40;</span>gethostbyname<span style="">&#40;</span>hostname_begin<span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ if <span style="">&#40;</span>!host_entry<span style="">&#41;</span></span>n <span style="">&#123;</span>n<span style="color: #991111;">- un_paired_socket_ = &amp;socket;</span>n<span style="color: #00b000;">+ throw NameResolutionError<span style="">&#40;</span>&quot;Name resolution error&quot;, GetLastError<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ else</span>n<span style="color: #00b000;">+ <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old resolved OK */ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ switch <span style="">&#40;</span>host_entry-&gt;h_addrtype<span style="">&#41;</span></span>n<span style="color: #00b000;">+ <span style="">&#123;</span></span>n<span style="color: #00b000;">+ case AF_INET :</span>n<span style="color: #00b000;">+ <span style="">&#123;</span></span>n<span style="color: #00b000;">+ sockaddr_in *a4<span style="">&#40;</span>reinterpret_cast&lt; sockaddr_in* &gt;<span style="">&#40;</span>&amp;address<span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ memcpy<span style="">&#40;</span>&amp;a4-&gt;sin_addr, host_entry-&gt;h_addr_list<span style="">&#91;</span><span style="">0</span><span style="">&#93;</span>, <span style="">4</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ a4-&gt;sin_port = port;</span>n<span style="color: #00b000;">+ break;</span>n<span style="color: #00b000;">+ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ case AF_INET6 :</span>n<span style="color: #00b000;">+ <span style="">&#123;</span></span>n<span style="color: #00b000;">+ sockaddr_in6 *a6<span style="">&#40;</span>reinterpret_cast&lt; sockaddr_in6* &gt;<span style="">&#40;</span>&amp;address<span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ memcpy<span style="">&#40;</span>&amp;a6-&gt;sin6_addr, host_entry-&gt;h_addr_list<span style="">&#91;</span><span style="">0</span><span style="">&#93;</span>, <span style="">16</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ a6-&gt;sin6_port = port;</span>n<span style="color: #00b000;">+ break;</span>n<span style="color: #00b000;">+ <span style="">&#125;</span></span>n <span style="">&#125;</span>n<span style="color: #00b000;">+ break;</span>n <span style="">&#125;</span>n<span style="color: #00b000;">+ case 4 :</span>n<span style="color: #00b000;">+ <span style="">&#123;</span></span>n<span style="color: #00b000;">+ // IP V6 address: X'04'</span>n<span style="color: #00b000;">+ if <span style="">&#40;</span>buffer.size<span style="">&#40;</span><span style="">&#41;</span> &lt; offsetof<span style="">&#40;</span>SocksRequest, dst_addr_<span style="">&#41;</span> + 16 + 2 /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old four for the address, two for the port */<span style="">&#41;</span></span>n<span style="color: #00b000;">+ <span style="">&#123;</span></span>n<span style="color: #00b000;">+ throw InsufficientData<span style="">&#40;</span>&quot;Not enough data for a SOCKS request&quot;<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ else</span>n<span style="color: #00b000;">+ <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old all is well so far */ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ address.ss_family = AF_INET6;</span>n<span style="color: #00b000;">+ sockaddr_in6 *a6<span style="">&#40;</span>reinterpret_cast&lt; sockaddr_in6* &gt;<span style="">&#40;</span>&amp;address<span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ memcpy<span style="">&#40;</span>&amp;a6-&gt;sin6_addr, message-&gt;dst_addr_, <span style="">16</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ memcpy<span style="">&#40;</span>&amp;a6-&gt;sin6_port, message-&gt;dst_addr_ + <span style="">16</span>, <span style="">2</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ break;</span>n<span style="color: #00b000;">+ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ default :</span>n<span style="color: #00b000;">+ throw UnknownAddressType<span style="">&#40;</span>&quot;Unknown address type&quot;, message-&gt;atyp_<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ switch <span style="">&#40;</span>message-&gt;cmd_<span style="">&#41;</span></span>n<span style="color: #00b000;">+ <span style="">&#123;</span></span>n<span style="color: #00b000;">+ case 1 :</span>n<span style="color: #00b000;">+ // CONNECT X'01'</span>n<span style="color: #00b000;">+ doConnect<span style="">&#40;</span>socket, address<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ break;</span>n<span style="color: #00b000;">+ case 2 :</span>n<span style="color: #00b000;">+ // BIND X'02' //TODO</span>n<span style="color: #00b000;">+ case 3 :</span>n<span style="color: #00b000;">+ // UDP ASSOCIATE X'03' //TODO</span>n<span style="color: #00b000;">+ break;</span>n<span style="color: #00b000;">+ <span style="">&#125;</span></span>n<span style="color: #00b000;">+<span style="">&#125;</span></span>n<span style="color: #00b000;">+</span>n<span style="color: #00b000;">+void Application::doConnect<span style="">&#40;</span>Socket &amp;parent_socket, const sockaddr_storage &amp;address<span style="">&#41;</span></span>n<span style="color: #00b000;">+<span style="">&#123;</span></span>n<span style="color: #00b000;">+ /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old In the reply to a CONNECT, BND.PORT contains the port number that the</span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml server assigned to connect to the target host, while BND.ADDR</span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml contains the associated IP address. The supplied BND.ADDR is often</span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml different from the IP address that the client uses to reach the SOCKS</span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml server, since such servers are often multi-homed. It is expected</span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml that the SOCKS server will use DST.ADDR and DST.PORT, and the</span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml client-side source address and port in evaluating the CONNECT</span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml request. */</span>n<span style="color: #00b000;">+ using Vlinder::Chausette::RFC1928::SocksReply;</span>n<span style="color: #00b000;">+ SocksReply reply;</span>n<span style="color: #00b000;">+ memset<span style="">&#40;</span>&amp;reply, <span style="">0</span>, sizeof<span style="">&#40;</span>reply<span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ reply.ver_ = CHAUSETTE_EPISODE35_SOCKS_VERSION;</span>n<span style="color: #00b000;">+ /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old attempt to connect to the target address. If successful, open a </span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml server socket for the client to connect to, and forward the data</span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml between the two. */</span>n<span style="color: #00b000;">+ int sock_fd<span style="">&#40;</span>::socket<span style="">&#40;</span>address.ss_family, SOCK_STREAM, IPPROTO_TCP<span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ if <span style="">&#40;</span>sock_fd == INVALID_SOCKET<span style="">&#41;</span></span>n<span style="color: #00b000;">+ <span style="">&#123;</span></span>n<span style="color: #00b000;">+ reply.rep_ = <span style="">1</span>; // X'01' general SOCKS server failure</span>n<span style="color: #00b000;">+ parent_socket.get<span style="">&#40;</span>socks_reply_attribute_id_<span style="">&#41;</span> = reply;</span>n<span style="color: #00b000;">+ setSocketState<span style="">&#40;</span>parent_socket, send_socks_reply__<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ else</span>n<span style="color: #00b000;">+ <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old all is well */ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ FDGuard fd_guard<span style="">&#40;</span>sock_fd<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ u_long arg<span style="">&#40;</span><span style="">1</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ if <span style="">&#40;</span>ioctlsocket<span style="">&#40;</span>sock_fd, FIONBIO, &amp;arg<span style="">&#41;</span> != 0<span style="">&#41;</span></span>n<span style="color: #00b000;">+ <span style="">&#123;</span></span>n<span style="color: #00b000;">+ reply.rep_ = <span style="">1</span>; // X'01' general SOCKS server failure</span>n<span style="color: #00b000;">+ parent_socket.get<span style="">&#40;</span>socks_reply_attribute_id_<span style="">&#41;</span> = reply;</span>n<span style="color: #00b000;">+ setSocketState<span style="">&#40;</span>parent_socket, send_socks_reply__<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ throw SocketIOCTLFailed<span style="">&#40;</span>&quot;Failed to set socket to non-blocking&quot;, WSAGetLastError<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ else</span>n<span style="color: #00b000;">+ <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old all is well so far */ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ if <span style="">&#40;</span>connect<span style="">&#40;</span>sock_fd, <span style="">&#40;</span>const sockaddr*<span style="">&#41;</span>&amp;address, sizeof<span style="">&#40;</span>address<span style="">&#41;</span><span style="">&#41;</span> != 0<span style="">&#41;</span></span>n<span style="color: #00b000;">+ <span style="">&#123;</span></span>n<span style="color: #00b000;">+ unsigned long last_error<span style="">&#40;</span>WSAGetLastError<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ switch <span style="">&#40;</span>last_error<span style="">&#41;</span></span>n<span style="color: #00b000;">+ <span style="">&#123;</span></span>n<span style="color: #00b000;">+ // logic errors</span>n<span style="color: #00b000;">+ case WSANOTINITIALISED :</span>n<span style="color: #00b000;">+ /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old A successful WSAStartup call must occur before using this function. */</span>n<span style="color: #00b000;">+ case WSAEADDRINUSE :</span>n<span style="color: #00b000;">+ /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old The socket's local address is already in use and the socket was not </span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml marked to allow address reuse with SO_REUSEADDR. This error usually </span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml occurs when executing bind, but could be delayed until the connect </span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml function if the bind was to a wildcard address <span style="">&#40;</span>INADDR_ANY or </span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml in6addr_any<span style="">&#41;</span> for the local IP address. A specific address needs to </span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml be implicitly bound by the connect function. */</span>n<span style="color: #00b000;">+ case WSAEINTR :</span>n<span style="color: #00b000;">+ /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old The blocking Windows Socket 1.1 call was canceled through </span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml WSACancelBlockingCall. */</span>n<span style="color: #00b000;">+ case WSAEINPROGRESS :</span>n<span style="color: #00b000;">+ /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old A blocking Windows Sockets 1.1 call is in progress, or the service </span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml provider is still processing a callback function. */</span>n<span style="color: #00b000;">+ case WSAEALREADY :</span>n<span style="color: #00b000;">+ /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old A nonblocking connect call is in progress on the specified socket.</span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml Note In order to preserve backward compatibility, this error is reported </span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml as WSAEINVAL to Windows Sockets 1.1 applications that link to either </span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml Winsock.dll or Wsock32.dll. */</span>n<span style="color: #00b000;">+ case WSAEAFNOSUPPORT :</span>n<span style="color: #00b000;">+ /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old Addresses in the specified family cannot be used with this socket. */</span>n<span style="color: #00b000;">+ case WSAEINVAL :</span>n<span style="color: #00b000;">+ /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old The parameter s is a listening socket. */</span>n<span style="color: #00b000;">+ case WSAEISCONN :</span>n<span style="color: #00b000;">+ /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old The socket is already connected <span style="">&#40;</span>connection-oriented sockets only<span style="">&#41;</span>. */</span>n<span style="color: #00b000;">+ case WSAENOTSOCK :</span>n<span style="color: #00b000;">+ /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old The descriptor specified in the s parameter is not a socket. */</span>n<span style="color: #00b000;">+ case WSAEACCES :</span>n<span style="color: #00b000;">+ /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old An attempt to connect a datagram socket to broadcast address failed </span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml because setsockopt option SO_BROADCAST is not enabled. */</span>n<span style="color: #00b000;">+ default :</span>n<span style="color: #00b000;">+ reply.rep_ = <span style="">1</span>; // X'01' general SOCKS server failure</span>n<span style="color: #00b000;">+ parent_socket.get<span style="">&#40;</span>socks_reply_attribute_id_<span style="">&#41;</span> = reply;</span>n<span style="color: #00b000;">+ setSocketState<span style="">&#40;</span>parent_socket, send_socks_reply__<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ throw ConnectError<span style="">&#40;</span>&quot;Internal error calling connect&quot;, last_error<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+</span>n<span style="color: #00b000;">+ // run-time errors outside the caller's control</span>n<span style="color: #00b000;">+ case WSAENETDOWN :</span>n<span style="color: #00b000;">+ /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old The network subsystem has failed. */</span>n<span style="color: #00b000;">+ reply.rep_ = <span style="">1</span>; // X'01' general SOCKS server failure</span>n<span style="color: #00b000;">+ parent_socket.get<span style="">&#40;</span>socks_reply_attribute_id_<span style="">&#41;</span> = reply;</span>n<span style="color: #00b000;">+ setSocketState<span style="">&#40;</span>parent_socket, send_socks_reply__<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ break;</span>n<span style="color: #00b000;">+ case WSAECONNREFUSED :</span>n<span style="color: #00b000;">+ /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old The attempt to connect was forcefully rejected. */</span>n<span style="color: #00b000;">+ reply.rep_ = <span style="">5</span>; // X'05' Connection refused</span>n<span style="color: #00b000;">+ parent_socket.get<span style="">&#40;</span>socks_reply_attribute_id_<span style="">&#41;</span> = reply;</span>n<span style="color: #00b000;">+ setSocketState<span style="">&#40;</span>parent_socket, send_socks_reply__<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ break;</span>n<span style="color: #00b000;">+ case WSAENETUNREACH :</span>n<span style="color: #00b000;">+ /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old The network cannot be reached from this host at this time. */</span>n<span style="color: #00b000;">+ reply.rep_ = <span style="">3</span>; // X'03' Network unreachable</span>n<span style="color: #00b000;">+ parent_socket.get<span style="">&#40;</span>socks_reply_attribute_id_<span style="">&#41;</span> = reply;</span>n<span style="color: #00b000;">+ setSocketState<span style="">&#40;</span>parent_socket, send_socks_reply__<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ break;</span>n<span style="color: #00b000;">+ case WSAEHOSTUNREACH :</span>n<span style="color: #00b000;">+ /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old A socket operation was attempted to an unreachable host. */</span>n<span style="color: #00b000;">+ reply.rep_ = <span style="">4</span>; // X'04' Host unreachable</span>n<span style="color: #00b000;">+ parent_socket.get<span style="">&#40;</span>socks_reply_attribute_id_<span style="">&#41;</span> = reply;</span>n<span style="color: #00b000;">+ setSocketState<span style="">&#40;</span>parent_socket, send_socks_reply__<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ break;</span>n<span style="color: #00b000;">+ case WSAENOBUFS :</span>n<span style="color: #00b000;">+ /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old Note No buffer space is available. The socket cannot be connected. */</span>n<span style="color: #00b000;">+ reply.rep_ = <span style="">1</span>; // X'01' general SOCKS server failure</span>n<span style="color: #00b000;">+ parent_socket.get<span style="">&#40;</span>socks_reply_attribute_id_<span style="">&#41;</span> = reply;</span>n<span style="color: #00b000;">+ setSocketState<span style="">&#40;</span>parent_socket, send_socks_reply__<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ break;</span>n<span style="color: #00b000;">+ case WSAETIMEDOUT :</span>n<span style="color: #00b000;">+ /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old An attempt to connect timed out without establishing a connection. */</span>n<span style="color: #00b000;">+ reply.rep_ = <span style="">6</span>; // X'06' TTL expired</span>n<span style="color: #00b000;">+ parent_socket.get<span style="">&#40;</span>socks_reply_attribute_id_<span style="">&#41;</span> = reply;</span>n<span style="color: #00b000;">+ setSocketState<span style="">&#40;</span>parent_socket, send_socks_reply__<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ break;</span>n<span style="color: #00b000;">+</span>n<span style="color: #00b000;">+ // run-time errors that point to bugs in the caller/client</span>n<span style="color: #00b000;">+ case WSAEADDRNOTAVAIL :</span>n<span style="color: #00b000;">+ /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old The remote address is not a valid address <span style="">&#40;</span>such as INADDR_ANY or in6addr_any<span style="">&#41;</span> . */</span>n<span style="color: #00b000;">+ case WSAEFAULT :</span>n<span style="color: #00b000;">+ /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old The sockaddr structure pointed to by the name contains incorrect address format </span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml for the associated address family or the namelen parameter is too small. This error </span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml is also returned if the sockaddr structure pointed to by the name parameter with </span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml a length specified in the namelen parameter is not in a valid part of the user </span>n<span style="color: #00b000;">+ 2017-10-14-new-website.md 2017-10-14-new-website.md~ split.sh split.sh~ wp_post_100.txt wp_post_10.txt wp_post_11.txt wp_post_12.txt wp_post_13.txt wp_post_14.txt wp_post_15.txt wp_post_16.txt wp_post_17.txt wp_post_18.txt wp_post_19.txt wp_post_1.yml wp_post_20.txt wp_post_21.txt wp_post_22.txt wp_post_23.txt wp_post_24.txt wp_post_25.txt wp_post_26.txt wp_post_27.txt wp_post_28.txt wp_post_29.txt wp_post_2.txt wp_post_30.txt wp_post_31.txt wp_post_32.txt wp_post_33.txt wp_post_34.txt wp_post_35.txt wp_post_36.txt wp_post_37.txt wp_post_38.txt wp_post_39.txt wp_post_3.txt wp_post_40.txt wp_post_41.txt wp_post_42.txt wp_post_43.txt wp_post_44.txt wp_post_45.txt wp_post_46.txt wp_post_47.txt wp_post_48.txt wp_post_49.txt wp_post_4.txt wp_post_50.txt wp_post_51.txt wp_post_52.txt wp_post_53.txt wp_post_54.txt wp_post_55.txt wp_post_56.txt wp_post_57.txt wp_post_58.txt wp_post_59.txt wp_post_5.txt wp_post_60.txt wp_post_61.txt wp_post_62.txt wp_post_63.txt wp_post_64.txt wp_post_65.txt wp_post_66.txt wp_post_67.txt wp_post_68.txt wp_post_69.txt wp_post_6.txt wp_post_70.txt wp_post_71.txt wp_post_72.txt wp_post_73.txt wp_post_74.txt wp_post_75.txt wp_post_76.txt wp_post_77.txt wp_post_78.txt wp_post_79.txt wp_post_7.txt wp_post_80.txt wp_post_81.txt wp_post_82.txt wp_post_83.txt wp_post_84.txt wp_post_85.txt wp_post_86.txt wp_post_87.txt wp_post_88.txt wp_post_89.txt wp_post_8.txt wp_post_90.txt wp_post_91.txt wp_post_92.txt wp_post_93.txt wp_post_94.txt wp_post_95.txt wp_post_96.txt wp_post_97.txt wp_post_98.txt wp_post_99.txt wp_post_9.txt wp_posts.yml address space. */</span>n<span style="color: #00b000;">+ reply.rep_ = <span style="">8</span>; // X'08' Address type not supported</span>n<span style="color: #00b000;">+ parent_socket.get<span style="">&#40;</span>socks_reply_attribute_id_<span style="">&#41;</span> = reply;</span>n<span style="color: #00b000;">+ setSocketState<span style="">&#40;</span>parent_socket, send_socks_reply__<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ break;</span>n<span style="color: #00b000;">+</span>n<span style="color: #00b000;">+ // &quot;normal&quot; errors</span>n<span style="color: #00b000;">+ case WSAEWOULDBLOCK :</span>n<span style="color: #00b000;">+ /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old The socket is marked as nonblocking and the connection cannot be completed immediately. */</span>n<span style="color: #00b000;">+ parent_socket.get<span style="">&#40;</span>socks_reply_attribute_id_<span style="">&#41;</span> = reply;</span>n<span style="color: #00b000;">+ setSocketState<span style="">&#40;</span>parent_socket, wait_socks_reply__<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ break;</span>n<span style="color: #00b000;">+ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ <span style="">&#125;</span></span>n<span style="color: #00b000;">+ else</span>n<span style="color: #00b000;">+ <span style="">&#123;</span> /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /snap /srv /sys /tmp /usr /var /vmlinuz /vmlinuz.old all is well */ <span style="">&#125;</span></span>n<span style="color: #00b000;">+<span style="">&#125;</span></span>n<span style="color: #00b000;">+</span>n<span style="color: #00b000;">+void Application::setSocketState<span style="">&#40;</span>Socket &amp;socket, Application::SocketState state<span style="">&#41;</span></span>n<span style="color: #00b000;">+<span style="">&#123;</span></span>n<span style="color: #00b000;">+ SocketState current_state<span style="">&#40;</span>any_cast&lt; SocketState &gt;<span style="">&#40;</span>socket.get<span style="">&#40;</span>socket_state_attribute_id_<span style="">&#41;</span><span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ //TODO</span>n<span style="color: #00b000;">+<span style="">&#125;</span></span>n<span style="color: #00b000;">+</span>n&nbsp;n<span style="color: #991111;">-void Application::unpairSocket<span style="">&#40;</span>Socket &amp;socket<span style="">&#41;</span></span>n<span style="color: #00b000;">+void Application::queueDataToSend<span style="">&#40;</span>Socket &amp;socket, unsigned char *begin, unsigned char *end<span style="">&#41;</span> const</span>n <span style="">&#123;</span>n<span style="color: #991111;">- // find the socket this one was paired to</span>n<span style="color: #991111;">- if <span style="">&#40;</span>un_paired_socket_ == &amp;socket<span style="">&#41;</span></span>n<span style="color: #00b000;">+ Buffer *buffer<span style="">&#40;</span><span style="">0</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ if <span style="">&#40;</span>!socket.get<span style="">&#40;</span>send_buffer_attribute_id_<span style="">&#41;</span>.empty<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span></span>n <span style="">&#123;</span>n<span style="color: #991111;">- un_paired_socket_ = <span style="">0</span>;</span>n<span style="color: #00b000;">+ buffer = &amp;<span style="">&#40;</span>any_cast&lt; Buffer&amp; &gt;<span style="">&#40;</span>socket.get<span style="">&#40;</span>send_buffer_attribute_id_<span style="">&#41;</span><span style="">&#41;</span><span style="">&#41;</span>;</span>n <span style="">&#125;</span>n elsen <span style="">&#123;</span>n<span style="color: #991111;">- assert<span style="">&#40;</span>!socket.get<span style="">&#40;</span>target_address_attribute_id_<span style="">&#41;</span>.empty<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #991111;">- sockaddr_storage target_address<span style="">&#40;</span>any_cast&lt; sockaddr_storage &gt;<span style="">&#40;</span>socket.get<span style="">&#40;</span>target_address_attribute_id_<span style="">&#41;</span><span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #991111;">- Socket *other_socket<span style="">&#40;</span>remote_address_to_socket_<span style="">&#91;</span>target_address<span style="">&#93;</span><span style="">&#41;</span>;</span>n other_socket-&gt;get<span style="">&#40;</span>target_address_attribute_id_<span style="">&#41;</span> = any<span style="">&#40;</span><span style="">&#41;</span>;n<span style="color: #991111;">- pairSocket<span style="">&#40;</span>*other_socket<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ socket.get<span style="">&#40;</span>send_buffer_attribute_id_<span style="">&#41;</span> = Buffer<span style="">&#40;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ buffer = &amp;<span style="">&#40;</span>any_cast&lt; Buffer&amp; &gt;<span style="">&#40;</span>socket.get<span style="">&#40;</span>send_buffer_attribute_id_<span style="">&#41;</span><span style="">&#41;</span><span style="">&#41;</span>;</span>n <span style="">&#125;</span>n<span style="color: #00b000;">+ copy<span style="">&#40;</span>begin, end, back_inserter<span style="">&#40;</span>*buffer<span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ unsigned int data<span style="">&#40;</span>buffer-&gt;size<span style="">&#40;</span><span style="">&#41;</span><span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ server_-&gt;write<span style="">&#40;</span>socket, &amp;<span style="">&#40;</span><span style="">&#40;</span>*buffer<span style="">&#41;</span><span style="">&#91;</span><span style="">0</span><span style="">&#93;</span><span style="">&#41;</span>, &amp;data<span style="">&#41;</span>;</span>n<span style="color: #00b000;">+ buffer-&gt;erase<span style="">&#40;</span>buffer-&gt;begin<span style="">&#40;</span><span style="">&#41;</span>, buffer-&gt;begin<span style="">&#40;</span><span style="">&#41;</span> + data<span style="">&#41;</span>;</span>n <span style="">&#125;</span></pre></td></tr></table></div>nn<p></div></p>n<p>We are going to have to manage different kinds of sockets: sockets for command-and-control (which we will call &#8220;control sockets&#8221; from here on) and sockets that need to be proxied. At first, we&#8217;ll just do TCP proxying but, eventually, we will also proxy UDP.</p>n<p>The way this is going to work, we will have only one thread to do most of the work &#8212; so we&#8217;ll have to be relatively smart about multiplexing our work. In this context, multiplexing means that we tell the sockets API &#8212; and therefore the underlying TCP/IP stack &#8212; what we want it to do, but we don&#8217;t wait around for it to perform its tasks: rather, we tell it to notify us whenever a task is finished and will carry it on from there. For that to work we do, of course, need to know what task it was performing. We do that by associating a <em>state</em> with each socket, which we put in one of the attributes, which we will call <code>socket_state_attribute_id_</code>. That attribute is allocated in the constructor and used throughout the code. For example, in <code>onDataReady</code>, it is used to know what to do with the incoming data:</p>n<div class="aside-toggler closed"><span class="open-aside code">To see the <em>code</em> click here.</span><span class="close-aside code">To hide the <em>code</em> click here.</span>n </div><div class="bnsia aside code closed"></p>nn<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>132n133n134n135n136n137n138n139n140n141n142n143n144n145n146n147n</pre></td><td class="code"><pre class="cpp" style="font-family:monospace;"><span style="color: #666666;">// here, according to the state of the socket, dispatch the data</span>n<span style="color: #0000ff;">if</span> <span style="color: #008000;">&#40;</span>socket.<span style="color: #007788;">get</span><span style="color: #008000;">&#40;</span>socket_state_attribute_id_<span style="color: #008000;">&#41;</span>.<span style="color: #007788;">empty</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span>n<span style="color: #008000;">&#123;</span>n socket.<span style="color: #007788;">get</span><span style="color: #008000;">&#40;</span>socket_state_attribute_id_<span style="color: #008000;">&#41;</span> <span style="color: #000080;">=</span> expect_authentication_method_request__<span style="color: #008080;">;</span>n<span style="color: #008000;">&#125;</span>n<span style="color: #0000ff;">else</span>n<span style="color: #008000;">&#123;</span> <span style="color: #ff0000; font-style: italic;">/* the socket already has a state */</span> <span style="color: #008000;">&#125;</span>n<span style="color: #0000ff;">switch</span> <span style="color: #008000;">&#40;</span>any_cast<span style="color: #000080;">&lt;</span> SocketState <span style="color: #000080;">&gt;</span><span style="color: #008000;">&#40;</span>socket.<span style="color: #007788;">get</span><span style="color: #008000;">&#40;</span>socket_state_attribute_id_<span style="color: #008000;">&#41;</span>.<span style="color: #007788;">empty</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span>n<span style="color: #008000;">&#123;</span>n<span style="color: #0000ff;">case</span> expect_authentication_method_request__ <span style="color: #008080;">:</span>n onAuthenticationMethodRequest<span style="color: #008000;">&#40;</span>socket<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #0000ff;">break</span><span style="color: #008080;">;</span>n<span style="color: #0000ff;">case</span> expect_socks_request__ <span style="color: #008080;">:</span>n onSocksRequest<span style="color: #008000;">&#40;</span>socket<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #0000ff;">break</span><span style="color: #008080;">;</span>n<span style="color: #008000;">&#125;</span></pre></td></tr></table></div>nn<p></div>n<p>This basically turns the socket itself into a <a href="http://rlc.vlinder.ca/blog/2010/01/error-handling-in-c/" title="state machines, and error handling, in C" >state machine</a>. The available states would, of course, be different according to the role of the socket (i.e. a data socket would never be expected to send a SOCKS request).</p>n<p>We will look into state machines in the next installment.</p>n<p>Another important/interesting part of the new code is the parsing of SOCKS requests. We will look at the actions they imply later, but we will take a closer look at the parsing now:</p>n<p>The first step is to read the data from the buffer. If there isn&#8217;t enough data in the buffer, the request cannot be parsed and should be set aside. Some preliminary checks can be performed on the request immediately, as the following snippet of code will show:<br />n<div class="aside-toggler open"><span class="open-aside code">To see the <em>code</em> click here.</span><span class="close-aside code">To hide the <em>code</em> click here.</span>n </div><div class="bnsia aside code open"></p>nn<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>181n182n183n184n185n186n187n188n189n190n191n</pre></td><td class="code"><pre class="cpp" style="font-family:monospace;"><span style="color: #0000ff;">void</span> Application<span style="color: #008080;">::</span><span style="color: #007788;">onAuthenticationMethodRequest</span><span style="color: #008000;">&#40;</span>Socket <span style="color: #000040;">&amp;</span>socket<span style="color: #008000;">&#41;</span> <span style="color: #0000ff;">const</span>n<span style="color: #008000;">&#123;</span>n <span style="color: #0000ff;">using</span> Vlinder<span style="color: #008080;">::</span><span style="color: #007788;">Chausette</span><span style="color: #008080;">::</span><span style="color: #007788;">RFC1928</span><span style="color: #008080;">::</span><span style="color: #007788;">VersionIdentifierMethodSelectionMessage</span><span style="color: #008080;">;</span>n <span style="color: #0000ff;">using</span> Vlinder<span style="color: #008080;">::</span><span style="color: #007788;">Chausette</span><span style="color: #008080;">::</span><span style="color: #007788;">RFC1928</span><span style="color: #008080;">::</span><span style="color: #007788;">MethodMessage</span><span style="color: #008080;">;</span>n Buffer <span style="color: #000040;">&amp;</span>buffer<span style="color: #008000;">&#40;</span>any_cast<span style="color: #000080;">&lt;</span> Buffer<span style="color: #000040;">&amp;</span> <span style="color: #000080;">&gt;</span><span style="color: #008000;">&#40;</span>socket.<span style="color: #007788;">get</span><span style="color: #008000;">&#40;</span>receive_buffer_attribute_id_<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #0000ff;">if</span> <span style="color: #008000;">&#40;</span>buffer.<span style="color: #007788;">size</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span> <span style="color: #000080;">&lt;</span> <span style="color: #0000dd;">offsetof</span><span style="color: #008000;">&#40;</span>VersionIdentifierMethodSelectionMessage, methods_<span style="color: #008000;">&#41;</span> <span style="color: #000040;">+</span> <span style="color: #0000dd;">1</span><span style="color: #008000;">&#41;</span>n <span style="color: #008000;">&#123;</span>n <span style="color: #0000ff;">throw</span> InsufficientData<span style="color: #008000;">&#40;</span><span style="color: #FF0000;">&quot;Not enough data for a version identifier/method selection message&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #008000;">&#125;</span>n <span style="color: #0000ff;">else</span>n <span style="color: #008000;">&#123;</span> <span style="color: #ff0000; font-style: italic;">/* all is well so far */</span> <span style="color: #008000;">&#125;</span></pre></td></tr></table></div>nn<p></div></p>n<p>Now that we know we at least have enough data, we can treat the data as a message and, assuming the data in the buffer is either properly aligned, or we don&#8217;t care about the alignment, we can simply cast the buffer to the appropriate message type and do some more preliminary checks:</p>n<div class="aside-toggler open"><span class="open-aside code">To see the <em>code</em> click here.</span><span class="close-aside code">To hide the <em>code</em> click here.</span>n </div><div class="bnsia aside code open"></p>nn<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>192n193n194n195n196n197n198n199n200n201n202n203n204n205n</pre></td><td class="code"><pre class="cpp" style="font-family:monospace;"> VersionIdentifierMethodSelectionMessage <span style="color: #000040;">*</span>message<span style="color: #008000;">&#40;</span><span style="color: #0000ff;">reinterpret_cast</span><span style="color: #000080;">&lt;</span> VersionIdentifierMethodSelectionMessage<span style="color: #000040;">*</span> <span style="color: #000080;">&gt;</span><span style="color: #008000;">&#40;</span><span style="color: #000040;">&amp;</span>buffer<span style="color: #008000;">&#91;</span><span style="color: #0000dd;">0</span><span style="color: #008000;">&#93;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #0000ff;">if</span> <span style="color: #008000;">&#40;</span>message<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>ver_ <span style="color: #000040;">!</span><span style="color: #000080;">=</span> CHAUSETTE_EPISODE35_SOCKS_VERSION<span style="color: #008000;">&#41;</span>n <span style="color: #008000;">&#123;</span>n <span style="color: #0000ff;">throw</span> WrongSocksVersion<span style="color: #008000;">&#40;</span><span style="color: #FF0000;">&quot;Wrong socks version&quot;</span>, CHAUSETTE_EPISODE35_SOCKS_VERSION, message<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>ver_<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #008000;">&#125;</span>n <span style="color: #0000ff;">else</span>n <span style="color: #008000;">&#123;</span> <span style="color: #ff0000; font-style: italic;">/* the version is OK */</span> <span style="color: #008000;">&#125;</span>n <span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">int</span> message_size<span style="color: #008000;">&#40;</span><span style="color: #0000dd;">offsetof</span><span style="color: #008000;">&#40;</span>VersionIdentifierMethodSelectionMessage, methods_<span style="color: #008000;">&#41;</span> <span style="color: #000040;">+</span> message<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>nmethods_<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #0000ff;">if</span> <span style="color: #008000;">&#40;</span>buffer.<span style="color: #007788;">size</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span> <span style="color: #000080;">&lt;</span> message_size<span style="color: #008000;">&#41;</span>n <span style="color: #008000;">&#123;</span>n <span style="color: #0000ff;">throw</span> InsufficientData<span style="color: #008000;">&#40;</span><span style="color: #FF0000;">&quot;Not enough data for a version identifier/method selection message&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #008000;">&#125;</span>n <span style="color: #0000ff;">else</span>n <span style="color: #008000;">&#123;</span> <span style="color: #ff0000; font-style: italic;">/* all is well so far */</span> <span style="color: #008000;">&#125;</span></pre></td></tr></table></div>nn<p></div>n<p>In this specific message, we&#8217;re setting up an authentication method &#8211; we won&#8217;t support authentication right away, so for now, only method <code>0</code> is supported. According to the protocol, this means that at least one of the proposed authentication methods, of which there can be up to 255, has to be <code>0</code>.</p>n<div class="aside-toggler open"><span class="open-aside code">To see the <em>code</em> click here.</span><span class="close-aside code">To hide the <em>code</em> click here.</span>n </div><div class="bnsia aside code open"></p>nn<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>209n210n211n212n213n214n215n216n217n218n219n</pre></td><td class="code"><pre class="cpp" style="font-family:monospace;"> <span style="color: #0000ff;">bool</span> authentication_ok<span style="color: #008000;">&#40;</span><span style="color: #0000ff;">false</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #0000ff;">for</span> <span style="color: #008000;">&#40;</span><span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">char</span> <span style="color: #000040;">*</span>method <span style="color: #000080;">=</span> message<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>methods_<span style="color: #008080;">;</span> <span style="color: #000040;">!</span>authentication_ok <span style="color: #000040;">&amp;&amp;</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#40;</span>method <span style="color: #000040;">-</span> message<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>methods_<span style="color: #008000;">&#41;</span> <span style="color: #000080;">&lt;</span> message<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>nmethods_<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span> <span style="color: #000040;">++</span>method<span style="color: #008000;">&#41;</span>n <span style="color: #008000;">&#123;</span>n authentication_ok <span style="color: #000080;">=</span> <span style="color: #008000;">&#40;</span><span style="color: #000040;">*</span>method <span style="color: #000080;">==</span> <span style="color: #0000dd;">0</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #008000;">&#125;</span>n <span style="color: #0000ff;">if</span> <span style="color: #008000;">&#40;</span><span style="color: #000040;">!</span>authentication_ok<span style="color: #008000;">&#41;</span>n <span style="color: #008000;">&#123;</span>n <span style="color: #0000ff;">throw</span> NoSupportedAuthenticationMethod<span style="color: #008000;">&#40;</span><span style="color: #FF0000;">&quot;No supported authentication method&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #008000;">&#125;</span>n <span style="color: #0000ff;">else</span>n <span style="color: #008000;">&#123;</span> <span style="color: #ff0000; font-style: italic;">/* all is well */</span> <span style="color: #008000;">&#125;</span></pre></td></tr></table></div>nn<p></div>n<p>Once we&#8217;ve established that we can, indeed, authenticate (or rather: that we don&#8217;t need to) we can set up our reply, and send it.</p>n<div class="aside-toggler open"><span class="open-aside code">To see the <em>code</em> click here.</span><span class="close-aside code">To hide the <em>code</em> click here.</span>n </div><div class="bnsia aside code open"></p>nn<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>220n221n222n</pre></td><td class="code"><pre class="cpp" style="font-family:monospace;"> MethodMessage method_message<span style="color: #008000;">&#40;</span>CHAUSETTE_EPISODE35_SOCKS_VERSION, <span style="color: #0000dd;">0</span><span style="color: #ff0000; font-style: italic;">/* no authentication - put a constant here later */</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">char</span> <span style="color: #000040;">*</span>ptr<span style="color: #008000;">&#40;</span><span style="color: #0000ff;">reinterpret_cast</span><span style="color: #000080;">&lt;</span> <span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">char</span><span style="color: #000040;">*</span> <span style="color: #000080;">&gt;</span><span style="color: #008000;">&#40;</span><span style="color: #000040;">&amp;</span>method_message<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n queueDataToSend<span style="color: #008000;">&#40;</span>socket, ptr, ptr <span style="color: #000040;">+</span> <span style="color: #0000dd;">sizeof</span><span style="color: #008000;">&#40;</span>method_message<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span></pre></td></tr></table></div>nn<p></div>n<p>Then, we set the state of the socket to one in which we expect SOCKS requests &#8212; now that the initial handshaking is done &#8212; and consume the data we&#8217;ve already handled.</p>n<div class="aside-toggler open"><span class="open-aside code">To see the <em>code</em> click here.</span><span class="close-aside code">To hide the <em>code</em> click here.</span>n </div><div class="bnsia aside code open"></p>nn<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>223n224n</pre></td><td class="code"><pre class="cpp" style="font-family:monospace;"> socket.<span style="color: #007788;">get</span><span style="color: #008000;">&#40;</span>socket_state_attribute_id_<span style="color: #008000;">&#41;</span> <span style="color: #000080;">=</span> expect_socks_request__<span style="color: #008080;">;</span>n buffer.<span style="color: #007788;">erase</span><span style="color: #008000;">&#40;</span>buffer.<span style="color: #007788;">begin</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>, buffer.<span style="color: #007788;">begin</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span> <span style="color: #000040;">+</span> message_size<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span></pre></td></tr></table></div>nn<p></div>n<p>SOCKS requests are handled pretty much the same way, but contain an address &#8212; the IP address of the host we will be proxying with. According to the address type, there are different ways to extract the IP address of the host we will be proxying with. It can either contain the actual IPv4 address, as in the next bit of code:<br />n<div class="aside-toggler open"><span class="open-aside code">To see the <em>code</em> click here.</span><span class="close-aside code">To hide the <em>code</em> click here.</span>n </div><div class="bnsia aside code open"></p>nn<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>242n243n244n245n246n247n248n249n250n251n252n253n254n255n256n257n258n259n260n</pre></td><td class="code"><pre class="cpp" style="font-family:monospace;"> sockaddr_storage address<span style="color: #008080;">;</span>n <span style="color: #0000dd;">memset</span><span style="color: #008000;">&#40;</span><span style="color: #000040;">&amp;</span>address, <span style="color: #0000dd;">0</span>, <span style="color: #0000dd;">sizeof</span><span style="color: #008000;">&#40;</span>address<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #0000ff;">switch</span> <span style="color: #008000;">&#40;</span>message<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>atyp_<span style="color: #008000;">&#41;</span>n <span style="color: #008000;">&#123;</span>n <span style="color: #0000ff;">case</span> <span style="color: #0000dd;">1</span> <span style="color: #008080;">:</span>n <span style="color: #008000;">&#123;</span>n <span style="color: #666666;">// IP V4 address: X'01'</span>n <span style="color: #0000ff;">if</span> <span style="color: #008000;">&#40;</span>buffer.<span style="color: #007788;">size</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span> <span style="color: #000080;">&lt;</span> <span style="color: #0000dd;">offsetof</span><span style="color: #008000;">&#40;</span>SocksRequest, dst_addr_<span style="color: #008000;">&#41;</span> <span style="color: #000040;">+</span> <span style="color: #0000dd;">6</span> <span style="color: #ff0000; font-style: italic;">/* four for the address, two for the port */</span><span style="color: #008000;">&#41;</span>n <span style="color: #008000;">&#123;</span>n <span style="color: #0000ff;">throw</span> InsufficientData<span style="color: #008000;">&#40;</span><span style="color: #FF0000;">&quot;Not enough data for a SOCKS request&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #008000;">&#125;</span>n <span style="color: #0000ff;">else</span>n <span style="color: #008000;">&#123;</span> <span style="color: #ff0000; font-style: italic;">/* all is well so far */</span> <span style="color: #008000;">&#125;</span>n address.<span style="color: #007788;">ss_family</span> <span style="color: #000080;">=</span> AF_INET<span style="color: #008080;">;</span>n sockaddr_in <span style="color: #000040;">*</span>a4<span style="color: #008000;">&#40;</span><span style="color: #0000ff;">reinterpret_cast</span><span style="color: #000080;">&lt;</span> sockaddr_in<span style="color: #000040;">*</span> <span style="color: #000080;">&gt;</span><span style="color: #008000;">&#40;</span><span style="color: #000040;">&amp;</span>address<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #0000dd;">memcpy</span><span style="color: #008000;">&#40;</span><span style="color: #000040;">&amp;</span>a4<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>sin_addr, message<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>dst_addr_, <span style="color: #0000dd;">4</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #0000dd;">memcpy</span><span style="color: #008000;">&#40;</span><span style="color: #000040;">&amp;</span>a4<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>sin_port, message<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>dst_addr_ <span style="color: #000040;">+</span> <span style="color: #0000dd;">4</span>, <span style="color: #0000dd;">2</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #0000ff;">break</span><span style="color: #008080;">;</span>n <span style="color: #008000;">&#125;</span></pre></td></tr></table></div>nn<p></div><br />nor it can be a domain name, in which case the address has to be looked up.</p>n<p>Address lookup is done synchronously, using <code>gethostbyname</code>, but should eventually be done asynchronously as calling this function may take some time &#8212; time we don&#8217;t necessarily want to spend waiting.</p>n<div class="aside-toggler open"><span class="open-aside code">To see the <em>code</em> click here.</span><span class="close-aside code">To hide the <em>code</em> click here.</span>n </div><div class="bnsia aside code open"></p>nn<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>261n262n263n264n265n266n267n268n269n270n271n272n273n274n275n276n277n278n279n280n281n282n283n284n285n286n287n288n289n290n291n292n293n294n295n296n297n298n299n300n</pre></td><td class="code"><pre class="cpp" style="font-family:monospace;"> <span style="color: #0000ff;">case</span> <span style="color: #0000dd;">3</span> <span style="color: #008080;">:</span>n <span style="color: #008000;">&#123;</span>n <span style="color: #666666;">// DOMAINNAME: X'03'</span>n <span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">char</span> hostname_length<span style="color: #008000;">&#40;</span>message<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>dst_addr_<span style="color: #008000;">&#91;</span><span style="color: #0000dd;">0</span><span style="color: #008000;">&#93;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #0000ff;">if</span> <span style="color: #008000;">&#40;</span>buffer.<span style="color: #007788;">size</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span> <span style="color: #000080;">&lt;</span> <span style="color: #0000dd;">offsetof</span><span style="color: #008000;">&#40;</span>SocksRequest, dst_addr_<span style="color: #008000;">&#41;</span> <span style="color: #000040;">+</span> hostname_length <span style="color: #000040;">+</span> <span style="color: #0000dd;">2</span> <span style="color: #ff0000; font-style: italic;">/* hostname_length for the address, two for the port */</span><span style="color: #008000;">&#41;</span>n <span style="color: #008000;">&#123;</span>n <span style="color: #0000ff;">throw</span> InsufficientData<span style="color: #008000;">&#40;</span><span style="color: #FF0000;">&quot;Not enough data for a SOCKS request&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #008000;">&#125;</span>n <span style="color: #0000ff;">else</span>n <span style="color: #008000;">&#123;</span> <span style="color: #ff0000; font-style: italic;">/* all is well so far */</span> <span style="color: #008000;">&#125;</span>n <span style="color: #0000ff;">char</span> <span style="color: #000040;">*</span>hostname_begin<span style="color: #008000;">&#40;</span><span style="color: #0000ff;">reinterpret_cast</span><span style="color: #000080;">&lt;</span> <span style="color: #0000ff;">char</span><span style="color: #000040;">*</span> <span style="color: #000080;">&gt;</span><span style="color: #008000;">&#40;</span>message<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>dst_addr_ <span style="color: #000040;">+</span> <span style="color: #0000dd;">1</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #0000ff;">char</span> <span style="color: #000040;">*</span>hostname_end <span style="color: #000080;">=</span> hostname_begin <span style="color: #000040;">+</span> hostname_length<span style="color: #008080;">;</span>n <span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">short</span> port<span style="color: #008000;">&#40;</span><span style="color: #000040;">*</span><span style="color: #0000ff;">reinterpret_cast</span><span style="color: #000080;">&lt;</span> <span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">short</span><span style="color: #000040;">*</span> <span style="color: #000080;">&gt;</span><span style="color: #008000;">&#40;</span>hostname_end<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #000040;">*</span>hostname_end <span style="color: #000080;">=</span> <span style="color: #0000dd;">0</span><span style="color: #008080;">;</span> <span style="color: #666666;">// cap it off</span>n hostent <span style="color: #000040;">*</span>host_entry<span style="color: #008000;">&#40;</span>gethostbyname<span style="color: #008000;">&#40;</span>hostname_begin<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #0000ff;">if</span> <span style="color: #008000;">&#40;</span><span style="color: #000040;">!</span>host_entry<span style="color: #008000;">&#41;</span>n <span style="color: #008000;">&#123;</span>n <span style="color: #0000ff;">throw</span> NameResolutionError<span style="color: #008000;">&#40;</span><span style="color: #FF0000;">&quot;Name resolution error&quot;</span>, GetLastError<span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #008000;">&#125;</span>n <span style="color: #0000ff;">else</span>n <span style="color: #008000;">&#123;</span> <span style="color: #ff0000; font-style: italic;">/* resolved OK */</span> <span style="color: #008000;">&#125;</span>n <span style="color: #0000ff;">switch</span> <span style="color: #008000;">&#40;</span>host_entry<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>h_addrtype<span style="color: #008000;">&#41;</span>n <span style="color: #008000;">&#123;</span>n <span style="color: #0000ff;">case</span> AF_INET <span style="color: #008080;">:</span>n <span style="color: #008000;">&#123;</span>n sockaddr_in <span style="color: #000040;">*</span>a4<span style="color: #008000;">&#40;</span><span style="color: #0000ff;">reinterpret_cast</span><span style="color: #000080;">&lt;</span> sockaddr_in<span style="color: #000040;">*</span> <span style="color: #000080;">&gt;</span><span style="color: #008000;">&#40;</span><span style="color: #000040;">&amp;</span>address<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #0000dd;">memcpy</span><span style="color: #008000;">&#40;</span><span style="color: #000040;">&amp;</span>a4<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>sin_addr, host_entry<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>h_addr_list<span style="color: #008000;">&#91;</span><span style="color: #0000dd;">0</span><span style="color: #008000;">&#93;</span>, <span style="color: #0000dd;">4</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n a4<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>sin_port <span style="color: #000080;">=</span> port<span style="color: #008080;">;</span>n <span style="color: #0000ff;">break</span><span style="color: #008080;">;</span>n <span style="color: #008000;">&#125;</span>n <span style="color: #0000ff;">case</span> AF_INET6 <span style="color: #008080;">:</span>n <span style="color: #008000;">&#123;</span>n sockaddr_in6 <span style="color: #000040;">*</span>a6<span style="color: #008000;">&#40;</span><span style="color: #0000ff;">reinterpret_cast</span><span style="color: #000080;">&lt;</span> sockaddr_in6<span style="color: #000040;">*</span> <span style="color: #000080;">&gt;</span><span style="color: #008000;">&#40;</span><span style="color: #000040;">&amp;</span>address<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #0000dd;">memcpy</span><span style="color: #008000;">&#40;</span><span style="color: #000040;">&amp;</span>a6<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>sin6_addr, host_entry<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>h_addr_list<span style="color: #008000;">&#91;</span><span style="color: #0000dd;">0</span><span style="color: #008000;">&#93;</span>, <span style="color: #0000dd;">16</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n a6<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>sin6_port <span style="color: #000080;">=</span> port<span style="color: #008080;">;</span>n <span style="color: #0000ff;">break</span><span style="color: #008080;">;</span>n <span style="color: #008000;">&#125;</span>n <span style="color: #008000;">&#125;</span>n <span style="color: #0000ff;">break</span><span style="color: #008080;">;</span>n <span style="color: #008000;">&#125;</span></pre></td></tr></table></div>nn<p></div>n<p>The address can also be an IPv6, in which case, like in the case of an IPv4 address, it is simply copied.</p>n<div class="aside-toggler open"><span class="open-aside code">To see the <em>code</em> click here.</span><span class="close-aside code">To hide the <em>code</em> click here.</span>n </div><div class="bnsia aside code open"></p>nn<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>301n302n303n304n305n306n307n308n309n310n311n312n313n314n315n316n317n318n</pre></td><td class="code"><pre class="cpp" style="font-family:monospace;"> <span style="color: #0000ff;">case</span> <span style="color: #0000dd;">4</span> <span style="color: #008080;">:</span>n <span style="color: #008000;">&#123;</span>n <span style="color: #666666;">// IP V6 address: X'04'</span>n <span style="color: #0000ff;">if</span> <span style="color: #008000;">&#40;</span>buffer.<span style="color: #007788;">size</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span> <span style="color: #000080;">&lt;</span> <span style="color: #0000dd;">offsetof</span><span style="color: #008000;">&#40;</span>SocksRequest, dst_addr_<span style="color: #008000;">&#41;</span> <span style="color: #000040;">+</span> <span style="color: #0000dd;">16</span> <span style="color: #000040;">+</span> <span style="color: #0000dd;">2</span> <span style="color: #ff0000; font-style: italic;">/* four for the address, two for the port */</span><span style="color: #008000;">&#41;</span>n <span style="color: #008000;">&#123;</span>n <span style="color: #0000ff;">throw</span> InsufficientData<span style="color: #008000;">&#40;</span><span style="color: #FF0000;">&quot;Not enough data for a SOCKS request&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #008000;">&#125;</span>n <span style="color: #0000ff;">else</span>n <span style="color: #008000;">&#123;</span> <span style="color: #ff0000; font-style: italic;">/* all is well so far */</span> <span style="color: #008000;">&#125;</span>n address.<span style="color: #007788;">ss_family</span> <span style="color: #000080;">=</span> AF_INET6<span style="color: #008080;">;</span>n sockaddr_in6 <span style="color: #000040;">*</span>a6<span style="color: #008000;">&#40;</span><span style="color: #0000ff;">reinterpret_cast</span><span style="color: #000080;">&lt;</span> sockaddr_in6<span style="color: #000040;">*</span> <span style="color: #000080;">&gt;</span><span style="color: #008000;">&#40;</span><span style="color: #000040;">&amp;</span>address<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #0000dd;">memcpy</span><span style="color: #008000;">&#40;</span><span style="color: #000040;">&amp;</span>a6<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>sin6_addr, message<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>dst_addr_, <span style="color: #0000dd;">16</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #0000dd;">memcpy</span><span style="color: #008000;">&#40;</span><span style="color: #000040;">&amp;</span>a6<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>sin6_port, message<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>dst_addr_ <span style="color: #000040;">+</span> <span style="color: #0000dd;">16</span>, <span style="color: #0000dd;">2</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #0000ff;">break</span><span style="color: #008080;">;</span>n <span style="color: #008000;">&#125;</span>n <span style="color: #0000ff;">default</span> <span style="color: #008080;">:</span>n <span style="color: #0000ff;">throw</span> UnknownAddressType<span style="color: #008000;">&#40;</span><span style="color: #FF0000;">&quot;Unknown address type&quot;</span>, message<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>atyp_<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #008000;">&#125;</span></pre></td></tr></table></div>nn<p></div>n<p>There are a few things you should notice: invalid IP addresses and domain names are not necessarily a problem &#8212; they won&#8217;t work, of course, but there is really no other way to check for them than to try them out. The only thing we really check is that there&#8217;s enough data in the request to contain the information being extracted from the request.</p>n<p>Socks requests are fairly simple and don&#8217;t contain anything like checksums or cryptographic authentication (although cryptographic authentication can be part of the protocol, if supported by both sides) so other than these few checks, there is really nothing to be done.</p>n<p>Queueing data to send looks like this:<br />n<div class="aside-toggler open"><span class="open-aside code">To see the <em>code</em> click here.</span><span class="close-aside code">To hide the <em>code</em> click here.</span>n </div><div class="bnsia aside code open"></p>nn<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>503n504n505n506n507n508n509n510n511n512n513n514n515n516n517n518n519n</pre></td><td class="code"><pre class="cpp" style="font-family:monospace;"><span style="color: #0000ff;">void</span> Application<span style="color: #008080;">::</span><span style="color: #007788;">queueDataToSend</span><span style="color: #008000;">&#40;</span>Socket <span style="color: #000040;">&amp;</span>socket, <span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">char</span> <span style="color: #000040;">*</span>begin, <span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">char</span> <span style="color: #000040;">*</span>end<span style="color: #008000;">&#41;</span> <span style="color: #0000ff;">const</span>n<span style="color: #008000;">&#123;</span>n Buffer <span style="color: #000040;">*</span>buffer<span style="color: #008000;">&#40;</span><span style="color: #0000dd;">0</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #0000ff;">if</span> <span style="color: #008000;">&#40;</span><span style="color: #000040;">!</span>socket.<span style="color: #007788;">get</span><span style="color: #008000;">&#40;</span>send_buffer_attribute_id_<span style="color: #008000;">&#41;</span>.<span style="color: #007788;">empty</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span>n <span style="color: #008000;">&#123;</span>n buffer <span style="color: #000080;">=</span> <span style="color: #000040;">&amp;</span><span style="color: #008000;">&#40;</span>any_cast<span style="color: #000080;">&lt;</span> Buffer<span style="color: #000040;">&amp;</span> <span style="color: #000080;">&gt;</span><span style="color: #008000;">&#40;</span>socket.<span style="color: #007788;">get</span><span style="color: #008000;">&#40;</span>send_buffer_attribute_id_<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #008000;">&#125;</span>n <span style="color: #0000ff;">else</span>n <span style="color: #008000;">&#123;</span>n socket.<span style="color: #007788;">get</span><span style="color: #008000;">&#40;</span>send_buffer_attribute_id_<span style="color: #008000;">&#41;</span> <span style="color: #000080;">=</span> Buffer<span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n buffer <span style="color: #000080;">=</span> <span style="color: #000040;">&amp;</span><span style="color: #008000;">&#40;</span>any_cast<span style="color: #000080;">&lt;</span> Buffer<span style="color: #000040;">&amp;</span> <span style="color: #000080;">&gt;</span><span style="color: #008000;">&#40;</span>socket.<span style="color: #007788;">get</span><span style="color: #008000;">&#40;</span>send_buffer_attribute_id_<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #008000;">&#125;</span>n copy<span style="color: #008000;">&#40;</span>begin, end, back_inserter<span style="color: #008000;">&#40;</span><span style="color: #000040;">*</span>buffer<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">int</span> data<span style="color: #008000;">&#40;</span>buffer<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>size<span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n server_<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>write<span style="color: #008000;">&#40;</span>socket, <span style="color: #000040;">&amp;</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#40;</span><span style="color: #000040;">*</span>buffer<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#91;</span><span style="color: #0000dd;">0</span><span style="color: #008000;">&#93;</span><span style="color: #008000;">&#41;</span>, <span style="color: #000040;">&amp;</span>data<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n buffer<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>erase<span style="color: #008000;">&#40;</span>buffer<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>begin<span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>, buffer<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>begin<span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span> <span style="color: #000040;">+</span> data<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n<span style="color: #008000;">&#125;</span></pre></td></tr></table></div>nn<p></div></p>n<p>First thing we do is get a buffer to put the data into. That buffer is associated with the socket itself so that, if the socket isn&#8217;t ready for data being written to it, we can write the data to the socket when the socket <em>is</em> ready, in <code>onWriteReady</code>. The <code>Server</code> code will know what to do with a call to <code>write</code> if the socket isn&#8217;t ready, so we can simply call it and remove, from the buffer, any data that we could send.</p>n<p>The <code>onWriteReady</code> method is similar, of course:<br />n<div class="aside-toggler open"><span class="open-aside code">To see the <em>code</em> click here.</span><span class="close-aside code">To hide the <em>code</em> click here.</span>n </div><div class="bnsia aside code open"></p>nn<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>152n153n154n155n156n157n158n159n160n161n162n163n164n165n166n167n168n169n170n</pre></td><td class="code"><pre class="cpp" style="font-family:monospace;"><span style="color: #ff0000; font-style: italic;">/*virtual */</span><span style="color: #0000ff;">void</span> Application<span style="color: #008080;">::</span><span style="color: #007788;">onWriteReady</span><span style="color: #008000;">&#40;</span>Socket <span style="color: #000040;">&amp;</span>socket<span style="color: #008000;">&#41;</span>n<span style="color: #008000;">&#123;</span>n <span style="color: #0000ff;">if</span> <span style="color: #008000;">&#40;</span><span style="color: #000040;">!</span>socket.<span style="color: #007788;">get</span><span style="color: #008000;">&#40;</span>send_buffer_attribute_id_<span style="color: #008000;">&#41;</span>.<span style="color: #007788;">empty</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span>n <span style="color: #008000;">&#123;</span>n Buffer <span style="color: #000040;">&amp;</span>buffer<span style="color: #008000;">&#40;</span>any_cast<span style="color: #000080;">&lt;</span> Buffer<span style="color: #000040;">&amp;</span> <span style="color: #000080;">&gt;</span><span style="color: #008000;">&#40;</span>socket.<span style="color: #007788;">get</span><span style="color: #008000;">&#40;</span>send_buffer_attribute_id_<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n Buffer<span style="color: #008080;">::</span><span style="color: #007788;">size_type</span> offset<span style="color: #008000;">&#40;</span><span style="color: #0000dd;">0</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #0000ff;">if</span> <span style="color: #008000;">&#40;</span><span style="color: #000040;">!</span>buffer.<span style="color: #007788;">empty</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span>n <span style="color: #008000;">&#123;</span>n Buffer<span style="color: #008080;">::</span><span style="color: #007788;">size_type</span> avail<span style="color: #008000;">&#40;</span>buffer.<span style="color: #007788;">size</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n Buffer<span style="color: #008080;">::</span><span style="color: #007788;">pointer</span> send_ptr<span style="color: #008000;">&#40;</span><span style="color: #000040;">&amp;</span><span style="color: #008000;">&#40;</span>buffer<span style="color: #008000;">&#91;</span><span style="color: #0000dd;">0</span><span style="color: #008000;">&#93;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n server_<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>write<span style="color: #008000;">&#40;</span>socket, send_ptr, <span style="color: #000040;">&amp;</span>avail<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n buffer.<span style="color: #007788;">erase</span><span style="color: #008000;">&#40;</span>buffer.<span style="color: #007788;">begin</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>, buffer.<span style="color: #007788;">begin</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span> <span style="color: #000040;">+</span> avail<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>n <span style="color: #008000;">&#125;</span>n <span style="color: #0000ff;">else</span>n <span style="color: #008000;">&#123;</span> <span style="color: #ff0000; font-style: italic;">/* nothing to send */</span> <span style="color: #008000;">&#125;</span>n <span style="color: #008000;">&#125;</span>n <span style="color: #0000ff;">else</span>n <span style="color: #008000;">&#123;</span> <span style="color: #ff0000; font-style: italic;">/* nothing to send */</span> <span style="color: #008000;">&#125;</span>n<span style="color: #008000;">&#125;</span></pre></td></tr></table></div>nn<p></div></p>n<p>As you can see, it simply retrieves the buffer if there is one and sends as much of the available data as possible.</p>n<p>In the next few installments, we will look at the following:</p>n<ol>n<li><strong>state machines</strong>: as mentioned above, every socket will be construed as a state machine &#8212; but we will look at state machines in other contexts as well.</li>n<li><strong>threads</strong>: as mentioned above, some actions (such as DNS queries) will need to be performed asynchronously. We will do that by creating a thread to handle those requests.</li>n<li><strong>the Command pattern</strong> which we&#8217;ll be using to communicate with the thread</li>n</ol>nn"
post_title: "Setting up a new skeleton: re-factoring"
post_excerpt: "Before we go much further with our SOCKS server, we should do a bit of cleaning up in the project: we&rsquo;ll move the Server and Observer classes to their own library, so we can more easily re-use them, and we&rsquo;ll &hellip; <a href="http://rlc.vlinder.ca/blog/2011/12/setting-up-a-new-skeleton-re-factoring/">Continue reading <span>&rarr;</span></a>"
post_status: "inherit"
comment_status: "open"
ping_status: "open"
post_password: ""
post_name: "35-revision-v1"
to_ping: ""
pinged: ""
post_modified: "2014-03-31 11:06:34"
post_modified_gmt: "2014-03-31 15:06:34"
post_content_filtered: ""
post_parent: 35
guid: "http://cpp4theselftaught.com/2014/03/35-revision-v1/"
menu_order: 0
post_type: "revision"
post_mime_type: ""
comment_count: 0
